<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vincular Medidas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../css/Style.css">
    <link rel="stylesheet" href="../css/fichas.css">
    <script defer src="../js/ficha.js"></script>
    <script type="module" src="../js/navegar.js"></script>
</head>

<div class="modal fade" id="modal-generico" tabindex="-1" role="dialog" aria-labelledby="modalGenerico"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header border-bottom-0">
                </div>
                <div class="modal-body fs-4 text-center" id="body-modal-generico">
                    Existem alterações não salvas no seu pedido, deseja salvar?
                </div>
                <div class="modal-footer d-flex border-top-0 pt-0" id="conteudo-botao-modal">
                    <div class="d-flex w-100 justify-content-center align-items-center" id="footer-modal-generico">
                        <button type="button"
                            class="justify-content-center align-items-center rounded-5 p-2 rounded-button me-3"
                            data-dismiss="modal" style="background-color: #012171;">
                            <svg xmlns="http://www.w3.org/2000/svg" height="35px" viewBox="0 -960 960 960" width="35px"
                                fill="#FFFF">
                                <path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z" />
                            </svg>
                        </button>
                        <button type="button"
                            class="justify-content-center align-items-center rounded-5 p-2 rounded-button ms-3"
                            style="background-color: #012171;">
                            <svg xmlns="http://www.w3.org/2000/svg" height="35px" viewBox="0 -960 960 960" width="35px"
                                fill="#FFFF">
                                <path
                                    d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<body
    style="display: flex; flex-direction: column; background: linear-gradient(180deg, rgba(1,33,113,1) 0%, rgba(2,63,215,1) 100%);"
    onload="adicionarInformacoes();buscarDadosCliente(); validarOrigem()">
    <nav style="display: flex;flex-direction: column;padding-top:10%;color:white;align-items: center;">
        <div class="group" style="display: flex; align-items: space-around;">
            <a onclick="window.history.go(-1)"><img src="../assets/imgs/botao-voltar (1) 4.png" alt="voltar"
                    style="width:4vh"></a>
            <p class="h2" style="color:aliceblue">Ficha de<b> Medidas</b></p>
            <a onclick="window.history.go(-1)"><img src="../assets/imgs/icon_close.png" alt="Fechar" style="width:4vh"></a>
        </div>
        <img src="../assets/imgs/pontinhos3.png" alt="" class="pontinhos" style="width:10%;">

        <div id="clienteInfo" class="d-flex flex-column center mb-4 mt-3" style="align-items: center;">
            <h5 style="padding-top: 10%;" id="nomeCliente">Cleitinho<b></b></h5>
        </div>
        <!-- função existeDependente -->
        <div style="width: 95%; align-self: center;" id="dependente">
        </div>
    </nav>



    <div class="pt-5 pb-5 bg-light rounded" style="display:flex; flex-direction: column; justify-content: space-between; width: 90%;
        align-self: center;padding:20px;">

        <!-- informações -->
        <div class="border rounded p-1"
            style="color:#696969 ;border-color:#696969;display:flex; justify-content:space-between;"
            onclick="verInformacoes()">
            <p class="h5 pt-3 p-2">Ver mais informações</p>
            <button class="dropdown-toggle " style="background-color: transparent;font-size:1.5rem"></button>
        </div>
        <div class="p-1 " style="display:none;" id="verInfo">
            <p id="pecaInfo" class="border rounded px-3 p-2 " style="color:#696969 ;border-color:#696969">Peça:</p>
            <p id="tecidoInfo" class="border rounded px-3 p-2" style="color:#696969 ;border-color:#696969">Tecidos:</p>
            <input id="observacoesInput" type="text" style="color:#696969 ;border-color:#696969"
                class="border rounded p-2 px-2 w-100 " placeholder="Observações">
        </div>

        <div class="container">
            <div id="medidas" class="row">


            </div>
        </div>
        <button onclick="salvar()" class="salvar shadow-sm p-2 pt-3 pb-3">Salvar</button>
        <button onclick="transferirParaImportFicha()" id="import-ficha-btn" class="salvar shadow-sm p-2 pt-3 mt-3 pb-3">PDF <img src="../assets/import (1) 1.png"></button>
    </div>


</body>

</html>
<script>
    function verInformacoes() {
        var info = document.getElementById("verInfo")
        if (info.style.display == "none") {
            info.style.display = "block"
        } else {
            info.style.display = "none"
        }
    }
    let tecidoNomes = [];
    
    async function adicionarInformacoes() {
        var usuarioNome = sessionStorage.getItem("usuario")
        var peca = sessionStorage.getItem("PECA-ID")
        var idFicha = sessionStorage.getItem("FICHA-ID")
        var idCliente = sessionStorage.getItem("CLIENTE-ID")
        var idUsuario = sessionStorage.getItem("id")
    }

    async function getTecido(tecido) {
        var idUsuario = sessionStorage.getItem("id")
        var data = await fetch(`http://localhost:8080/tecidos/${idUsuario}/${tecido}`);
        if (!data.ok) {
            throw new Error('Erro ' + data.statusText);
        }
        var formatedData = await data.json()
        console.log(formatedData)
        document.getElementById("tecidoInfo").innerHTML += ` ${formatedData.nome} |`
        tecidoNomes.push(formatedData.nome)
    }


    var medidasTotais = null

    async function getmedidasPeca() {
        var idUsuario = sessionStorage.getItem("id")
        var peca = sessionStorage.getItem("PECA-ID")
        var data = await fetch(`http://localhost:8080/nomes-medidas/${idUsuario}/${peca}`);
        if (!data.ok) {
            throw new Error('Erro ' + data.statusText);
        }
        var formatedData = await data.json()
        console.log(formatedData)
        medidasTotais = formatedData
      
        for(var i = 0; i < formatedData.length; i++) {
            document.getElementById('medidas').innerHTML += `
             <div class="d-flex w-100 justify-space-between">
            <div class="col mb-3 border-bottom border-4 rounded shadow  p-2 " style="margin:1%;padding-right:50%;border-bottom:2px solid #004A97; height: 120px">
                    <p class="text-uppercase font-weight-normal d-flex justify-content-center label" id="${formatedData[i].id}">${formatedData[i].nome}</p>
                    <input id="" type="number" class="form-control w-100 d-flex justify-content-center input-valor-medida" style="border:none; background-color:none; text-align: center">
            </div>
        </div>`
    }


    document.querySelector("#pecaInfo").innerText = `Peça: ${medidasTotais[0].peca.nome}`
    }




    var idItemPedido = null
    async function salvar() {
        if(isFichaInvalida() == false){
        construirModalGenerico("statusButton", "modalGenerico.hide()", null, "Campos inválidos. Corrija e tente novamente")
        return
    } 

        var observacoesInput = document.getElementById("observacoesInput").value
        var idCliente = sessionStorage.getItem("CLIENTE-ID")
        var idUsuario = sessionStorage.getItem("id")
        var idPeca = sessionStorage.getItem("PECA-ID")
        const itemPedidoBody = {
            "observacao": observacoesInput,
            "cliente": {
                "id": idCliente
            },
            "usuario": {
                "id": idUsuario
            },
            "peca": {
                "id": idPeca
            }
        }
        itemPedido = await fetch(`http://localhost:8080/itens-pedidos/${idUsuario}/${idCliente}/${idPeca}`, {
            method: "POST",
            body: JSON.stringify(itemPedidoBody),
            headers: { "Content-type": "application/json; charset=UTF-8" },
        })
        if (!itemPedido.ok) {
            throw new Error('Erro ' + itemPedido.statusText);
        }
        var itemPedidoFormatado = await itemPedido.json()
        console.log(itemPedidoFormatado)
        idItemPedido = itemPedidoFormatado.id

       await validarCriacaoPedido(idItemPedido)
       await vincularMedidas()
       await vincularTecidos(idItemPedido)

        if(sessionStorage.getItem("CADASTRO-PEDIDO")){
            construirModalGenerico("statusButton", "modalGenerico.hide()", null, "Pedido criado com sucesso.")
            setTimeout(() => window.location.assign("http://localhost:3333/associar-ficha.html"), 800)  
        } else {
            construirModalGenerico("statusButton", "modalGenerico.hide()", null, "Ficha criada com sucesso.")
        }
    }

    async function vincularMedidas() {
        // const selectedMedidas = document.getElementById('medidas');
        // const medidas = selectedMedidas.querySelectorAll('inputMedida.class');
        // const medidasId = Array.from(medidas).map(medida => ({
        //     "id": medida.id,
        //     "medida": medida.value
        // }));
        // console.log(medidasId)

        console.log(medidasTotais)
        var idCliente = sessionStorage.getItem("CLIENTE-ID")
        var idUsuario = sessionStorage.getItem("id")
        var idPeca = sessionStorage.getItem("PECA-ID")
        
            var labels = document.querySelectorAll('.label')
            var inputs = document.querySelectorAll('.input-valor-medida')
            console.log(inputs)
            for(var i = 0; i < inputs.length; i++){
               await cadastrarMedida(labels[i].id, inputs[i].value, idUsuario, idCliente, idPeca, idItemPedido)
            }
            
        
        setTimeout(() => {
            window.location = "Lista_fichas.html"
        }, 2000);
    }

    async function vincularTecidos(itemPedidoId){
       const tecidos = sessionStorage.getItem("tecidos")
       const listaTecido = JSON.parse(tecidos)

       for(var i = 0; i < listaTecido.length; i++){
       await cadastrarColecaoTecido(itemPedidoId, listaTecido[i])
       }

    }

    async function cadastrarColecaoTecido(itemPedidoId, tecidoId){
        const usuarioId = sessionStorage.getItem("id")

        try{
            const response = await fetch(`http://localhost:8080/colecoes-tecidos/${usuarioId}/${itemPedidoId}/${tecidoId}`, {
                method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
               usuario: {
                id: usuarioId
               },
               itemPedido: {
                id: itemPedidoId
               },
               tecido: {
                id: tecidoId
               }
            })
            })

            var dados = await response.json()
            console.log(dados)
            return dados

        } catch(error){
            console.log("Ocorreu um erro: ")
            console.log(error)
        }
    }




    async function cadastrarMedida(idMedida, medidaValue, idUsuario, idCliente, idPeca, idItemPedido) {
        const medidaBody = {
            "valor": Number(medidaValue),
            "nomeMedida": { "id": idMedida },
            "itemPedido": { "id": idItemPedido },
            "cliente": { "id": idCliente },
            "usuario": { "id": idUsuario },
            "peca": { "id": idPeca }
        }
        var valorMedida = await fetch(`http://localhost:8080/valores-medidas/${idUsuario}/${idCliente}/${idPeca}/${idMedida}/${idItemPedido}`, {
            method: "POST",
            body: JSON.stringify(medidaBody),
            headers: { "Content-type": "application/json; charset=UTF-8" },
        })
        if (!valorMedida.ok) {
            throw new Error('Erro ' + valorMedida.statusText);
        }
        console.log("Vinculado Medida " + idMedida)
    }


    // async function atualizarMedida

    async function buscarValoresMedida(){
        var idUsuario = sessionStorage.getItem("id")
        var idFicha = sessionStorage.getItem("FICHA-ID") 
    

        try{
          const response =  await fetch(`http://localhost:8080/valores-medidas/${idUsuario}/${idFicha}`, {
            method: "GET"
          })

          const dados = await response.json()
          console.log(dados)
          preencherDadosValorMedida(dados)

        } catch(error){
            console.log(`Ocorreu um erro: ${error.message}`)
        }
    }

    async function preencherDadosValorMedida(valoresMedidas){
        const inputs = document.querySelectorAll('.input-valor-medida')
        for(var i = 0; i < valoresMedidas.length; i++){
            inputs[i].value = valoresMedidas[i].valor
            inputs[i].id = valoresMedidas[i].id
        }
        
        document.querySelector("#observacoesInput").value = `${valoresMedidas[0].itemPedido.observacao}`
    }

    async function buscarTecidosFicha(){
        var usuarioId = sessionStorage.getItem("id")
        var fichaId = sessionStorage.getItem("FICHA-ID")

        try{
            const response = await fetch(`http://localhost:8080/colecoes-tecidos/${usuarioId}/${fichaId}`, {
                method: "GET"
            })

            const dados = await response.json()
            console.log(dados)
            return dados

        } catch (error){
            console.log("Ocorreu um erro: ")
            console.log(error)
        }

    }


    async function preeencherTecidosFicha(){
        const listaTecido = await buscarTecidosFicha()

        var elementoTecidoInfo = document.querySelector("#tecidoInfo")
        var stringFormatada = "Tecidos: "
        for(var i = 0; i < listaTecido.length; i++){
            stringFormatada += ` ${listaTecido[i].tecido.nome} |`
        }

        elementoTecidoInfo.innerText = stringFormatada
    }

    async function validarOrigem(){
        var botaoSalvar = document.querySelector('.salvar')

        if(sessionStorage.getItem("E-VISUALIZACAO-FICHA")){
           await getmedidasPeca()
           await buscarValoresMedida()
           await preeencherTecidosFicha()
           botaoSalvar.setAttribute("onclick", "construirModalGenerico('actionButton', 'atualizarFicha()', 'modalGenerico.hide()', 'Deseja atualizar a ficha?')")
           botaoSalvar.innerText = "Atualizar"
           exibirBotaoPDF()
        } else {
           await getmedidasPeca()
           botaoSalvar.setAttribute("onclick", "construirModalGenerico('actionButton', 'salvar()', 'modalGenerico.hide()', 'Deseja salvar a ficha?')")
           botaoSalvar.innerText = "Salvar"
           ocultarBotaoPDF()
        }

        
    }

    
    async function atualizarFicha() {
    if(isFichaInvalida() == false){
        construirModalGenerico("statusButton", "modalGenerico.hide()", null, "Campos inválidos. Corrija e tente novamente")
        return
    } 

    var listaInput = document.querySelectorAll(".input-valor-medida")
    for(var i = 0; i < listaInput.length; i++){
       await atualizarValorMedida(listaInput[i].id, listaInput[i].value)
    }
    await atualizarObservacoes()
    construirModalGenerico("statusButton", "modalGenerico.hide()", null, "Ficha atualizada com sucesso")
}

async function atualizarValorMedida(valorMedidaId, valor) {
    const usuarioId = sessionStorage.getItem('id')

    try{
        var response = await fetch(`http://localhost:8080/valores-medidas/${usuarioId}/${valorMedidaId}?valorMedidaAtualizado=${valor}`, {
            method: "PUT"
        })

        var dados = await response.json()
        console.log(dados)
        return dados

    } catch(error) {
        console.log("Ocorreu um erro: ")
        console.log(error)
    }
}

async function atualizarObservacoes(){
    const usuarioId = sessionStorage.getItem("id")
    const fichaId = sessionStorage.getItem("FICHA-ID")
    const valorObservacao = document.querySelector("#observacoesInput").value 

    try{
        const response = await fetch(`http://localhost:8080/itens-pedidos/${usuarioId}/${fichaId}?observacao=${valorObservacao}`, {
            method: "PATCH"
        })


        if(response.ok){
            var dados = await response.json()
            console.log(dados)
            return dados
        }
       

    } catch(error){
        console.log(`Ocorreu um erro: ${error}`)
        alert(`Ocorreu um erro: ${error.message}`)
    }
}

async function criarPedido(){
    const novoitemPedido = buscarItemPedido()
    const agendamentoConsultado = await buscarAgendamento()

    try{
        const response = await fetch("http://localhost:8080/pedido", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                itemPedido: novoitemPedido.id,
                agendamento: agendamentoConsultado.id,
                usuario: novoitemPedido.usuario.id,
                etapa: agendamentoConsultado.etapa.id,
                cliente: agendamentoConsultado.cliente.id,
            })
        })


        const dados = await response.json()
        console.log(dados)
        return dados

    } catch(error){
        console.log("Ocorreu um erro: ")
        console.log(error)
    }
    
}

async function buscarItemPedido(){
    const usuarioId = sessionStorage.getItem("id")
    const itemPedidoId = sessionStorage.getItem("ITEM-PEDIDO-ID")

    try{
        const response =  await fetch(`http://localhost:8080/itens-pedidos/${usuarioId}/${itemPedidoId}/buscar-um`, {
            method: "GET"
        })

        const dados = await response.json()
        console.log(dados)
        return dados

    } catch(error){
        console.log("Ocorreu um erro:")
        console.log(error)
    }
}

async function buscarPedido(){
    const usuarioId = sessionStorage.getItem("id")
    const pedidoId = sessionStorage.getItem("PEDIDO-ID")

    try{
        const response =  await fetch(`http://localhost:8080/pedido/${usuarioId}/${pedidoId}`, {
            method: "GET"
        })

        const dados = await response.json()
        console.log(dados)
        return dados

    } catch(error){
        console.log("Ocorreu um erro:")
        console.log(error)
    }
}


async function buscarAgendamento() {

var agendamentoId = sessionStorage.getItem("AGENDAMENTO-ID")
var usuarioId = sessionStorage.getItem("id")

try {
    const response = await fetch(`http://localhost:8080/agendamento/${usuarioId}/${agendamentoId}`, {
        method: "GET"
    });

    if (!response.ok) {
        throw new Error(`Erro de servidor, status: ${response.status}`);
    }

    if (response.status == 204) {
        return []
    }

    
    const dados = await response.json()
    console.log(dados)
    return dados

} catch (error) {

    console.log(`Houve um erro: ${error}`)
}

}

async function validarCriacaoPedido(itemPedidoId) {
    if(!sessionStorage.getItem("CADASTRO-PEDIDO")) return
    sessionStorage.setItem("ITEM-PEDIDO-ID", itemPedidoId)
    var pedido = await criarPedido()
}


function exibirBotaoPDF(){
    const botaoImport = document.querySelector("#import-ficha-btn")
    if(botaoImport.classList.contains('d-none')){
        botaoImport.classList.remove('d-none')
    }
}

function ocultarBotaoPDF(){
    const botaoImport = document.querySelector("#import-ficha-btn")
    if(!botaoImport.classList.contains('d-none')){
        botaoImport.classList.add('d-none')
    }
}

async function buscarValoresMedidas(){
    const usuarioId = sessionStorage.getItem("id")
    const itemPedidoId = sessionStorage.getItem("FICHA-ID")

    try{
        const response =  await fetch(`http://localhost:8080/valores-medidas/${usuarioId}/${itemPedidoId}`, {
            method: "GET"
        })

        const dados = await response.json()
        console.log(dados)
        return dados

    } catch(error){
        console.log("Ocorreu um erro:")
        console.log(error)
    }
}


async function criarObjetoFicha(){
    const valoresMedidas = await buscarValoresMedidas()
    const fichaData = {
        nome: valoresMedidas[0].cliente.nome,
        responsavel: validarExistenciaResponsavel(valoresMedidas[0].cliente),
        peca: valoresMedidas[0].itemPedido.peca.nome,
        tecidos: tecidoNomes,
        medidas: inserirMedidasFormatadas(valoresMedidas),
    };
    
    sessionStorage.setItem("FICHA", JSON.stringify(fichaData))
    return fichaData
}

async function transferirParaImportFicha(){
    await console.log(criarObjetoFicha()) 
    setTimeout( () => {
        location.assign("http://localhost:3333/importar-ficha.html")
    }, 500)
}

function inserirMedidasFormatadas(listaValorMedida){
    var medidas = []
    for(var i = 0; i < listaValorMedida.length; i++){
        medidas.push({nome: listaValorMedida[i].nomeMedida.nome, valor: listaValorMedida[i].valor})
    }
    return medidas
}

async function inserirTecidosFormatados(){
    console.log(tecidoNomes)
    var listaTecido = tecidoNomes
}

function validarExistenciaResponsavel(cliente){
    if(cliente.responsavel != null && cliente.responsavel.nome != null){
        return cliente.responsavel.nome
    } 

    return null
}

function isFichaInvalida(){
    var fichaValida = true
    const valoresMedidas = document.querySelectorAll(".input-valor-medida")
    for(var i = 0; i < valoresMedidas.length; i++){
        if(valoresMedidas[i].value == '') estilizarInputInvalidaEInvalidarFicha(valoresMedidas[i])
        else estilizarInputValida(valoresMedidas[i])
    }

    if(fichaValida) removerEstilizacao(valoresMedidas)
    return fichaValida

    function estilizarInputInvalidaEInvalidarFicha(elemento){
        if(!elemento.classList.contains('is-invalid')){
            elemento.classList.add("is-invalid")
        }
        fichaValida = false
    }

    function estilizarInputValida(elemento){
        if(elemento.classList.contains('is-invalid')){
            elemento.classList.remove("is-invalid")
        }

        if(!elemento.classList.contains('is-valid')){
            elemento.classList.add("is-valid")
        }
    }

    function removerEstilizacao(valoresMedidas){
        for(var i = 0; i < valoresMedidas.length; i++){
            if(valoresMedidas[i].classList.contains("is-valid")){
                valoresMedidas[i].classList.remove("is-valid")
            }
        }
    }

    
}

if (document.querySelector('#modal-generico')) {
    const modalGenerico = new bootstrap.Modal(document.getElementById('modal-generico'))
  
    window.modalGenerico = modalGenerico
}


function construirModalGenerico(elementoId, primeiraFuncao, segundaFuncao, textoModal) {
    var elementoBody = document.querySelector("#body-modal-generico")
    var elementoFooter = document.querySelector("#footer-modal-generico")
  
    elementoFooter.innerHTML = ""
  
    if (elementoId == "statusButton") {
      elementoFooter.innerHTML =
        `
       <button type="button" class="justify-content-center align-items-center rounded-5 p-2 rounded-button me-3" onclick="${primeiraFuncao}" style="background-color: #012171;">
          <svg xmlns="http://www.w3.org/2000/svg" height="35px" viewBox="0 -960 960 960" width="35px" fill="#FFFF"><path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z"/></svg>
      </button>
      `
      modalGenerico.show()
    }
  
    if (elementoId == "actionButton") {
      elementoFooter.innerHTML = `
  
      <button type="button" class="justify-content-center align-items-center rounded-5 p-2 rounded-button me-3" onclick=${primeiraFuncao}  style="background-color: #012171;">
          <svg xmlns="http://www.w3.org/2000/svg" height="35px" viewBox="0 -960 960 960" width="35px" fill="#FFFF"><path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z"/></svg>
      </button>
  
      <button type="button" class="justify-content-center align-items-center rounded-5 p-2 rounded-button ms-3" onclick=${segundaFuncao} style="background-color: #012171;">
          <svg xmlns="http://www.w3.org/2000/svg" height="35px" viewBox="0 -960 960 960" width="35px" fill="#FFFF"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>
      </button>
      `
  
      modalGenerico.show()
    }

    elementoBody.innerText = textoModal
}





    
</script>
</script>