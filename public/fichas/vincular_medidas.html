<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vincular Medidas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../css/Style.css">
    <link rel="stylesheet" href="../css/fichas.css">
    <script defer src="../js/ficha.js"></script>
</head>

<body
    style="display: flex; flex-direction: column; background: linear-gradient(180deg, rgba(1,33,113,1) 0%, rgba(2,63,215,1) 100%);"
    onload="adicionarInformacoes();getmedidasPeca();buscarDadosCliente(); validarOrigem()">
    <nav style="display: flex;flex-direction: column;padding-top:10%;color:white;align-items: center;">
        <div class="group" style="display: flex; align-items: space-around;">
            <a href="Lista_fichas.html"><img src="../assets/imgs/botao-voltar (1) 4.png" alt="voltar"
                    style="width:4vh"></a>
            <p class="h2" style="color:aliceblue">Ficha de<b> Medidas</b></p>
            <a href="Lista_fichas.html"><img src="../assets/imgs/icon_close.png" alt="Fechar" style="width:4vh"></a>
        </div>
        <img src="../assets/imgs/pontinhos3.png" alt="" class="pontinhos" style="width:10%;">

        <div id="clienteInfo" class="d-flex flex-column center mb-4 mt-3" style="align-items: center;">
            <h5 style="padding-top: 10%;" id="nomeCliente"><b></b></h5>
        </div>
        <!-- função existeDependente -->
        <div style="width: 95%; align-self: center;" id="dependente">
        </div>
    </nav>



    <div class="pt-5 pb-5 bg-light rounded" style="display:flex; flex-direction: column; justify-content: space-between; width: 90%;
        align-self: center;padding:20px;">

        <!-- informações -->
        <div class="border rounded p-1"
            style="color:#696969 ;border-color:#696969;display:flex; justify-content:space-between;"
            onclick="verInformacoes()">
            <p class="h5 pt-3 p-2">Ver mais informações</p>
            <button class="dropdown-toggle " style="background-color: transparent;font-size:1.5rem"></button>
        </div>
        <div class="p-1 " style="display:none;" id="verInfo">
            <p id="pecaInfo" class="border rounded px-3 p-2 " style="color:#696969 ;border-color:#696969">Peça:</p>
            <p id="tecidoInfo" class="border rounded px-3 p-2" style="color:#696969 ;border-color:#696969">Tecidos:</p>
            <input id="observacoesInput" type="text" style="color:#696969 ;border-color:#696969"
                class="border rounded p-2 px-2 w-100 " placeholder="Observações">
        </div>

        <div class="container">
            <div id="medidas" class="row">


            </div>
        </div>
        <button onclick="salvar()" class="salvar shadow-sm p-2 pt-3 pb-3">Salvar</button>
    </div>


</body>

</html>
<script>
    function verInformacoes() {
        var info = document.getElementById("verInfo")
        if (info.style.display == "none") {
            info.style.display = "block"
        } else {
            info.style.display = "none"
        }
    }

    async function adicionarInformacoes() {
        var usuarioNome = sessionStorage.getItem("usuario")
        var peca = sessionStorage.getItem("peca")
        var idFicha = sessionStorage.getItem("idFicha")
        var idCliente = sessionStorage.getItem("idCliente")
        var idUsuario = sessionStorage.getItem("id")
        var tecidos = JSON.parse(sessionStorage.getItem("tecidos"))

        document.getElementById("pecaInfo").innerHTML += ` ${peca}`

        tecidos.map(tecido => {

            getTecido(tecido)
        })


    }

    async function getTecido(tecido) {
        var idUsuario = sessionStorage.getItem("id")
        var data = await fetch(`http://localhost:8080/tecidos/${idUsuario}/${tecido}`);
        if (!data.ok) {
            throw new Error('Erro ' + data.statusText);
        }
        var formatedData = await data.json()
        console.log(formatedData)
        document.getElementById("tecidoInfo").innerHTML += ` ${formatedData.nome} |`
    }


    var medidasTotais = null

    async function getmedidasPeca() {
        var idUsuario = sessionStorage.getItem("id")
        var peca = sessionStorage.getItem("peca")
        var data = await fetch(`http://localhost:8080/nomes-medidas/${idUsuario}/${peca}`);
        if (!data.ok) {
            throw new Error('Erro ' + data.statusText);
        }
        var formatedData = await data.json()
        console.log(formatedData)
        medidasTotais = formatedData

        validarOrigem()
      
        for(var i = 0; i < formatedData.length; i++) {
            document.getElementById('medidas').innerHTML += `
             <div class="d-flex w-100 justify-space-between">
            <div class="col mb-3 border-bottom border-4 rounded shadow  p-2 " style="margin:1%;padding-right:50%;border-bottom:2px solid #004A97; height: 120px">
                    <p class="text-uppercase font-weight-normal d-flex justify-content-center label" id="${formatedData[i].id}">${formatedData[i].nome}</p>
                    <input id="" type="text" class="form-control w-25 d-flex justify-content-center input-valor-medida" style="border:none; background-color:none">
            </div>
        </div>`
    }

       

    }




    var idItemPedido = null
    async function salvar() {
        var observacoesInput = document.getElementById("observacoesInput").value
        var idCliente = sessionStorage.getItem("idCliente")
        var idUsuario = sessionStorage.getItem("id")
        var idPeca = sessionStorage.getItem("peca")
        const itemPedidoBody = {
            "observacao": observacoesInput,
            "cliente": {
                "id": idCliente
            },
            "usuario": {
                "id": idUsuario
            },
            "peca": {
                "id": idPeca
            }
        }
        itemPedido = await fetch(`http://localhost:8080/itens-pedidos/${idUsuario}/${idCliente}/${idPeca}`, {
            method: "POST",
            body: JSON.stringify(itemPedidoBody),
            headers: { "Content-type": "application/json; charset=UTF-8" },
        })
        if (!itemPedido.ok) {
            throw new Error('Erro ' + itemPedido.statusText);
        }
        var itemPedidoFormatado = await itemPedido.json()
        console.log(itemPedidoFormatado)
        idItemPedido = itemPedidoFormatado.id

        const pedidoBody = {
            "itemPedido": idItemPedido,
            "agendamento": 1,
            "usuario": idUsuario,
            "etapa": 1,
            "cliente": idCliente
        }
        // var pedidoFetch = await fetch(`http://localhost:8080/pedido`, {
        //     method: "POST" ,
        //     body: JSON.stringify(pedidoBody),
        //     headers: {"Content-type": "application/json; charset=UTF-8"},
        // })
        // if (!pedidoFetch.ok) {
        //     throw new Error('Erro ' + pedidoFetch.statusText);
        // }
        vincularMedidas()
    }

    async function vincularMedidas() {
        // const selectedMedidas = document.getElementById('medidas');
        // const medidas = selectedMedidas.querySelectorAll('inputMedida.class');
        // const medidasId = Array.from(medidas).map(medida => ({
        //     "id": medida.id,
        //     "medida": medida.value
        // }));
        // console.log(medidasId)

        console.log(medidasTotais)
        var idCliente = sessionStorage.getItem("idCliente")
        var idUsuario = sessionStorage.getItem("id")
        var idPeca = sessionStorage.getItem("peca")
        
            var labels = document.querySelectorAll('.label')
            var inputs = document.querySelectorAll('.input-valor-medida')
            console.log(inputs)
            for(var i = 0; i < inputs.length; i++){
                cadastrarMedida(labels[i].id, inputs[i].value, idUsuario, idCliente, idPeca, idItemPedido)
            }
            
        
        // setTimeout(() => {
        //     window.location = "Lista_fichas.html"
        // }, 2000);
    }

    async function cadastrarMedida(idMedida, medidaValue, idUsuario, idCliente, idPeca, idItemPedido) {
        const medidaBody = {
            "valor": Number(medidaValue),
            "nomeMedida": { "id": idMedida },
            "itemPedido": { "id": idItemPedido },
            "cliente": { "id": idCliente },
            "usuario": { "id": idUsuario },
            "peca": { "id": idPeca }
        }
        var valorMedida = await fetch(`http://localhost:8080/valores-medidas/${idUsuario}/${idCliente}/${idPeca}/${idMedida}/${idItemPedido}`, {
            method: "POST",
            body: JSON.stringify(medidaBody),
            headers: { "Content-type": "application/json; charset=UTF-8" },
        })
        if (!valorMedida.ok) {
            throw new Error('Erro ' + valorMedida.statusText);
        }
        console.log("Vinculado Medida " + idMedida)
    }

    async function buscarValoresMedida(){
        var idUsuario = sessionStorage.getItem("id")
        var idFicha = sessionStorage.getItem("idFicha") 
    

        try{
          const response =  await fetch(`http://localhost:8080/valores-medidas/${idUsuario}/${idFicha}`, {
            method: "GET"
          })

          const dados = await response.json()
          console.log(dados)
          preencherDadosValorMedida(dados)

        } catch(error){
            console.log(`Ocorreu um erro: ${error.message}`)
        }
    }

    async function preencherDadosValorMedida(valoresMedidas){
        const inputs = document.querySelectorAll('.input-valor-medida')
        for(var i = 0; i < valoresMedidas.length; i++){
            inputs[i].value = valoresMedidas[i].valor
            inputs[i].id = valoresMedidas[i].id
        }
    }

    function validarOrigem(){
        if(sessionStorage.getItem("E-VISUALIZACAO-FICHA")){
            buscarValoresMedida()
        }

        var botaoSalvar = document.querySelector('.salvar')
        botaoSalvar.onclick = ""
        botaoSalvar.innerText = "Atualizar"
    }
    
</script>
</script>